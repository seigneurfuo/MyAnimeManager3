name: Package application with Pyinstaller

on:
  push:
    branches: [ pyinstaller-with-github-actions ]
  pull_request:
    branches: [ pyinstaller-with-github-actions ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Get latest commit date on branch
      run: |
        # Get the commit date on the current branch
        LATEST_COMMIT_DATE=$(git show -s --format=%cd --date=format:"%Y.%m.%d")
        echo "LATEST_COMMIT_DATE=${LATEST_COMMIT_DATE}" >> $GITHUB_ENV
        echo "Latest commit date: ${LATEST_COMMIT_DATE}"

    - name: Changing DEV version to current tag
      run: sed -i "s/\"DEV\"/\"$LATEST_COMMIT_DATE\"/g" "src/core.py"

    - name: Instaling Pillow to convert png to ico for Application icon
      run: pip install -U pillow
     
    - name: Packaging application
      uses: JackMcKew/pyinstaller-action-windows@main
      with:
        path: .
        requirements: requirements.txt
        spec: .pyinstaller.spec

    - uses: actions/upload-artifact@v4
      with:
        name: ${{ github.event.repository.name }}-${{ env.LATEST_COMMIT_DATE }}-windows
        path: dist/windows
        compression-level: 9
        include-hidden-files: true

    - name: Create an empty file for the portable artifact
      run: touch dist/windows/MyAnimeManager3/_internal/.portable

    - uses: actions/upload-artifact@v4
      with:
        name: ${{ github.event.repository.name }}-${{ env.LATEST_COMMIT_DATE }}-windows-portable
        path: dist/windows
        compression-level: 9
        include-hidden-files: true
